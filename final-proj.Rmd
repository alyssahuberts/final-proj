---
title: "Final Project"
author: "Garrett Rolph"
date: "April 21, 2020"
output: html_document
---

## Background
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(readxl)
library(janitor)
library(ggplot2)
library(haven)
library(googlesheets4)
library(googlesheets)
library(pdftools)
library(snakecase)
```
The purpose of this project is to analyze the differences in educational outcome between students in different educational circumstances across the country. I plan to include data from as many of the 50 states as I can access, though some states are much more restrictive than others. Below, I have selected some data that was readily available to me on the Massachusetts Department of Education Website. Included is data detailing SAT performance by school district, per pupil expenditures by school district, and staff demographics by school district. 

```{r Alabama}
AL_outcomes <- read_excel("States/Alabama/2018-2019 Report Card Profile.xlsx", skip = 4)
AL_summary <- read_excel("States/Alabama/2017-2018 Summative Assessment Results (Data Center).xlsx") %>% clean_names() 
```

```{r Arkansas}
AR_ACT <- read_excel("States/Arkansas/G11ACT_Summary_2019.xlsx") %>% clean_names()
```

```{r California}
CA_directory <- read_excel("States/California/pubschls.xlsx", skip = 5) %>% 
  clean_names()
CA_SAT <- read_excel("States/California/sat19.xls") %>% clean_names()

CA_joined <- CA_directory %>% 
  full_join(CA_SAT, by = c("school" = "sname"))
```

```{r Colorado, message = FALSE}
CO_SAT <- read_excel("States/Colorado/2019 PSAT and SAT Disaggregated District and School Achievement Results.xlsx", skip = 10) %>% 
  clean_names()

CO_agg_SAT <- read_excel("States/Colorado/2019 PSAT SAT District and School Achievement Results.xlsx", skip = 10) %>% 
  clean_names()

CO_principal_sals <- read_excel("States/Colorado/2018-19 Average Principal and Asst Principal Salary by District.xlsx", skip = 3) %>% 
  clean_names() 

CO_supt_sals <- read_excel("States/Colorado/2018-19 Average Superintendent Salary by District.xlsx", skip = 3) %>% 
  clean_names()

CO_teacher_sals <- read_excel("States/Colorado/2018-19 Average Teacher Salary by District.xlsx", skip = 3) %>% 
  clean_names() %>% 
  rename("average_salary" = "x4",
         "district_name" = "orgnazation_name")

CO_turnover <- read_excel("States/Colorado/2018-19 Personnel Turnover Rate by District and Position Categories.xlsx", skip = 3) %>% 
  clean_names()

CO_ratios <- read_excel("States/Colorado/2018-19 Student Teacher Ratios.xlsx", skip = 2) %>% 
  clean_names() 

CO_teacher_demos <- read_excel("States/Colorado/2018-19 Teachers by District, Race and Gender.xlsx", skip = 3) %>% 
  clean_names() 
```

```{r CO score vs. teacher salary}
  CO_SAT_sals <- inner_join(CO_SAT, CO_teacher_sals, 
                            by = c("district_name" = "district_name")) %>% 
  rename("average_total_salary" = "x8") %>% 
  filter(!number_of_valid_scores == "< 16")
```

```{r}
CO_SAT_sals %>%
  group_by(gender, school_name) %>% 
  filter(test == "SAT") %>% 
  arrange(desc(mathematics_mean_score)) %>% 
  head(20) %>% 
  ggplot(aes(school_name, mathematics_mean_score, color = gender)) + geom_col() +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  expand_limits(y = -1)
```

```{r Colorado Top 20 Math Scores}
CO_gendered_outcomes <- CO_SAT_sals %>%
  group_by(gender) %>% 
  filter(test == "SAT") %>% 
  arrange(desc(mathematics_mean_score)) %>% 
  head(40) %>%    
    mutate(school_name = factor(school_name, levels = c(
    "LIBERTY COMMON CHARTER SCHOOL", "D'EVELYN JUNIOR/SENIOR HIGH SCHOOL", "DSST: BYERS HIGH SCHOOL", "THOMAS MACLAREN STATE CHARTER SCHOOL", "FAIRVIEW HIGH SCHOOL", "THE VANGUARD SCHOOL (HIGH)", "PEAK TO PEAK CHARTER SCHOOL", "STARGATE CHARTER SCHOOL","CHERRY CREEK HIGH SCHOOL", "PROSPECT RIDGE ACADEMY",  "STEM SCHOOL HIGHLANDS RANCH", "DSST: STAPLETON HIGH SCHOOL", "JEFFERSON ACADEMY HIGH SCHOOL",  "TCA COLLEGE PATHWAYS","SKYVIEW ACADEMY","MONARCH HIGH SCHOOL","FOSSIL RIDGE HIGH SCHOOL","COLORADO EARLY COLLEGES - PARKER","ROCK CANYON HIGH SCHOOL", "EVERGREEN HIGH SCHOOL","All Schools","DENVER SCHOOL OF THE ARTS","THE CLASSICAL ACADEMY HIGH SCHOOL", "PALMER RIDGE HIGH SCHOOL", "CHEYENNE MOUNTAIN HIGH SCHOOL","CRESTED BUTTE SECONDARY SCHOOL"))) %>% 
  ggplot(aes(school_name, mathematics_mean_score, fill = gender)) + geom_col(stat = 'identity',
                                                              position = 'dodge') +
  coord_flip() +
  theme_classic() +
  labs(title = "Average Scores by Gender",
       subtitle = "Of the top 20 Schools in Colorado",
       y = "Average Math Score",
       x = "School Name") +
    theme(axis.text.x = element_text(angle = 270, hjust = 1)) +
            scale_fill_discrete(name = "Gender")

CO_gendered_outcomes
```

```{r}
CO_gendered_outcomes %>% 
ggsave(filename = file.path("final-proj-shiny", "colorado_gender_outcome.png"))
```

```{r Connecticut, message = FALSE}
CN_expenditures <- read_sheet("https://docs.google.com/spreadsheets/d/12Hy7Wqal4eh8iaDBaxkWGonB1qiG6rbp0ClFstD4QZw/edit#gid=0", skip = 1) %>% clean_names()

CN_expenditures <- CN_expenditures[ ,-c(3:6)]
```

```{r}
CN_teacher_demos <- read_sheet("https://docs.google.com/spreadsheets/d/1hqd_BlUnN_iimltVFJhQqzvUJ58vcGnv8rdpZcdbZ40/edit#gid=0", skip = 1) %>% clean_names() 

CN_teacher_demos <- CN_teacher_demos[ ,-c(3:10)]
```

```{r}

CN_SAT <- read_sheet("https://docs.google.com/spreadsheets/d/1eEr8Vs80NQBzHORBG7n1kiQEAxMjnu0jdlY-AuJ9UUs/edit#gid=0", skip = 2) %>% clean_names()

CN_SAT <- CN_SAT[ , -c(3:11)]
```

```{r Connecticut joining}
CN_join1 <- CN_expenditures %>% 
  full_join(CN_teacher_demos, by = c("district" = "district"))
```



```{r Florida, include = FALSE}
FL_ACT <- read_excel("States/Florida/2017ACTSchool.xlsx", skip = 3) %>% 
  clean_names() %>% 
  rename(district_number = "x1",
         district_name = "x2",
         school_code = "x3",
         school_name = "x4",
         student_count = "x5")

FL_ACT <- data.frame(lapply(FL_ACT, function(x) {
                gsub('\\*', NA_character_, x)
             }))

FL_ACT <- FL_ACT %>% 
  mutate(average = mean(composite)) 

FL_teachersalaries <- read_excel("States/Florida/1819TeacherSalaryData.xlsx", skip = 2) %>% 
  clean_names()
FL_districtsalaries <- read_excel("States/Florida/1819FLDistStSalaries.xlsx", skip = 2) %>% 
  clean_names()
```

```{r Florida joined}
FL_join1 <- FL_ACT %>% 
  full_join(FL_teachersalaries, by = "district_name")

FL_joined <- FL_join1 %>% 
  full_join(FL_districtsalaries, by = "district_name")
```

```{r Georgia, include = FALSE}
ga_SAT <- read_excel("States/Georgia/School Level SAT.xlsx", skip = 3,
                     col_types = c("numeric", "text",
                                      "numeric", "numeric",
                                      "numeric", "numeric")) %>% 
  rename(math = "Math Mean") %>% clean_names()
  
ga_SAT <- data.frame(lapply(ga_SAT, function(x) {
                gsub('\\*', NA_character_, x)
             })) 

ga_SAT <- na.omit(ga_SAT) %>% 
  mutate(avg_math = mean(math)) %>% 
  filter(school_name == (str_replace(school_name, "HS", "High School")))
  

ga_ACT <- read_excel("States/Georgia/ACT Scores School 2019.xlsx",
                     col_types = c("text","numeric","text",
                                   "numeric","numeric","numeric","numeric")) %>% 
  clean_names()

ga_ACT <- data.frame(lapply(ga_ACT, function(x) {
                gsub('\\*', NA_character_, x)
             })) %>% 
  na.omit(ga_ACT) %>% 
  mutate(composite = mean(average_composite_score, na.rm = TRUE)) %>% 
        filter(hs_name == (str_replace(hs_name, "HS", "High School")))


ga_demographics <- read_csv("States/Georgia/FTE Enrollment by Race_Ethnicity and Gender Fiscal Year2020-1 Data Report.csv", skip = 3)
```

```{r Georgia joined}
GA_join1 <- ga_SAT %>% 
  full_join(ga_ACT, by = c("school_name" = "hs_name")) 
```

```{r Hawaii}
## I have a PDF for the ACT scores that I want Logen to convert into an excel file, and then I also would like him to work to find data on student enrollment percentiles.
```

```{r Indiana}
IN_SAT <- read_excel("States/Indiana/sat-corporation-and-school.xlsx",
                     col_types = c("text", "numeric", "text", "numeric", "numeric",
                                   "numeric", "numeric", "numeric", "numeric", "numeric")) %>% clean_names() %>% 
  mutate(percent_graduates_taking_sat = (percent_graduates_taking_sat*100))

IN_ACT <- read_excel("States/Indiana/act-corporation-and-school.xlsx", 
                     col_types = c("text", "numeric", "text", "numeric", "numeric",
                                   "numeric", "numeric", "numeric", "numeric", "numeric", "numeric")) %>% clean_names() %>% 
  mutate(percent_graduates_taking_act = (percent_graduates_taking_act*100)) %>% 
  filter(year == "2017-2018")

IN_financial <- read_excel("States/Indiana/fy2019-school-level-financial-data-media.xlsx") %>% 
  clean_names() %>% 
  filter(str_detect(school_type, "High School")) 
```

```{r Indiana joined}
IN_join1 <- IN_SAT %>% 
  full_join(IN_ACT, by = "corp_name")

IN_joined <- IN_join1 %>% 
  full_join(IN_financial, by = c("corp_name" = "school_name"))
```

```{r Iowa}
IO_salaries <- read_excel("States/Iowa/2019-2020 Iowa Public School Full Time Teachers_1.xlsx", skip = 13) %>% clean_names() %>%
  select(-x6, -x10, -x13, -x15, -x19, -x23, -x26, -x28, -x31, -x41, -x51) 

IO_demos <- read_excel("States/Iowa/2019-2020 Iowa Public School District PreK-12 Enrollments by District, Grade, Race and Gender.xlsx", skip = 4) %>% clean_names()

IO_ACT <- read_excel("States/Iowa/Iowa_2019_Public_Schools_Graduating_Class_5yr_trends_District level_no small Ns.xlsx", skip = 2) %>% clean_names()
```

```{r Kentucky}
KY_ACT <- read_excel("States/Kentucky/ASSESSMENT_ACT.xlsx") %>% clean_names()

KY_teacher_salaries <- read_excel("States/Kentucky/Average Classroom Teacher Salaries (1989-2020) ADA.xlsx", skip = 3) %>% clean_names() %>% select(1,2,90:91)

KY_teacher_demos <- read_excel("States/Kentucky/Classroom Teacher Ethnic-Gender Count (2020) ADA.xlsx", skip = 3) %>% clean_names() 

KY_finances <- read_excel("States/Kentucky/FINANCE.xlsx") %>% clean_names() %>% 
  filter(finance_label == c("Total Expenditures", "Total Expenditure Per Pupil", "Average Teacher Salary", "Average Principal Salary"))

KY_learning_envir <- read_excel("States/Kentucky/LEARNING_ENVIRONMENT_STUDENTS-TEACHERS.xlsx") %>% clean_names() %>% 
  filter(grade == c("Grade 09", "Grade 10", "Grade 11", "Grade 12"))

KY_admin_salaries <- read_excel("States/Kentucky/Superintendent Salaries (2001-2020) ADA.xlsx", skip = 5) %>% clean_names() %>% 
select(1,2,34,36) %>% 
  rename("school_name" = x2,
        "2018-2019" = "x2018_2019",
         "2019-2020" = "x2019_2020")
```

```{r Kentucky joined}
KY_join1 <- KY_ACT %>% 
  right_join(KY_teacher_salaries, by = c("dist_number" = "dist_no")) 

KY_join2 <- KY_join1 %>% 
  right_join(KY_admin_salaries, by = c("dist_number" = "district_name"))

KY_join3 <- KY_join2 %>% 
  right_join(KY_finances, by = "dist_number")

KY_join4 <- KY_join3 %>% 
  right_join(KY_learning_envir, by = "dist_number")
```

```{r Louisiana}
LA_teacher_salaries <- read_excel("States/Louisiana/2018-2019-actual-public-classroom-teacher-salary-averages-by-school-district.xlsx", skip = 6) %>% clean_names() 
LA_teacher_salaries <- LA_teacher_salaries[-c(1,3), ] 

LA_ACT <- read_excel("States/Louisiana/act-scores-class-of-2019.xlsx", skip = 4) %>% 
  clean_names()
```

```{r}
LA_joined <- LA_ACT %>% 
  full_join(LA_teacher_salaries, by = c("district" = "lea_name"))
```

```{r Massachusetts, include = FALSE}
MA_SAT_18_19 <- read_excel("States/Massachusetts/sat_performance.xlsx", 
                        col_types = c("text", "numeric",
                                      "numeric", "numeric",
                                      "logical", "numeric"),
                        skip = 1) %>% 
  clean_names() %>% 
  mutate(avg_reading = 
          mean(reading_writing, na.rm = TRUE),
         avg_math =
           mean(math, na.rm = TRUE)) 

MA_PPE_18 <- read_excel("States/Massachusetts/PerPupilExpenditures.xlsx",
                        col_types = c("text", "numeric",
                                      "numeric", "text",
                                      "text", "text",
                                      "text", "text",
                                      "logical"),
                        skip = 1) %>% 
  clean_names() %>% 
  select(-x9)

mass_staff_demographics <- read_excel("States/Massachusetts/staffracegender.xlsx",
                                      skip = 1)

mass_salaries <- read_excel("States/Massachusetts/TeacherSalaries.xlsx")

MA_join1 <- MA_SAT_18_19 %>% 
  full_join(MA_PPE_18, by = c("district_name" = "district_name",
                              "district_code" = "district_code"))
```

```{r Nevada}
NV_outcomes <- read_sheet("https://docs.google.com/spreadsheets/d/1Zl3vlRZG0OM_XKch9YbWYjnSTtiWcSPYjyePHA4wls4/edit#gid=0") %>% clean_names() %>% 
  rename(district_name = group) 

NV_demographics <- read_sheet("https://docs.google.com/spreadsheets/d/1J18F48EbJZtMVVfBJ8WyT4PV1Cjjqz2bHoFfyGxUbQ8/edit#gid=0") %>% clean_names() %>% 
  rename(district_name = name) 

NV_financial <- read_sheet("https://docs.google.com/spreadsheets/d/1oZfvjQfvO05fLT8ArgJYrvs2zsmGmoyfGee0tptEWkA/edit#gid=0") %>% clean_names() %>% 
  rename(district_name = name)
```

```{r Nevada joined}
NV_join1 <- NV_outcomes %>% 
  full_join(NV_demographics, by = "district_name")

NV_joined <- NV_join1 %>% 
  full_join(NV_financial, by = "district_name")
```

```{r Oklahoma}
OK_ACT <- read_excel("States/Oklahoma/District level_ACT_2016_Senior.xlsx") %>% 
  clean_names()

OK_staff <- read_excel("States/Oklahoma/CertStaff_SPR-FY1920_2020-03-12-MidYr.xlsx", skip = 1) %>% clean_names() 

OK_teachers <- OK_staff %>% 
  filter(jobcode == "210") 

OK_supt <- OK_staff %>% 
  filter(jobcode == "115")
```

```{r Pennsylvania}
PA_grad_rate <- read_sheet("https://docs.google.com/spreadsheets/d/1TwjzeJbMc2zu0o1Hgmx4LfVKkYfgLfe9DXGbKYLHNyQ/edit#gid=0") %>% clean_names()

PA_ACT <- read_excel("States/Pennsylvania/2019 ACT Scores for Public Schools.xlsx", skip = 7) %>%
  clean_names()

PA_SAT <- read_excel("States/Pennsylvania/2019 SAT Scores for Public Schools.xlsx", skip = 5) %>%
  clean_names()
```

```{r South Carolina, include = FALSE}
SC_ACT <- read_excel("States/South Carolina/SAT2019_Schoolsfinal.xlsx", skip = 2) %>% 
  clean_names()
SC_SAT <- read_excel("States/South Carolina/ACT-Schools2019.xlsx", skip = 1) %>% 
  clean_names()

## The SC_expenditures needs to be fixed, and I think I'd like to pivot the
## columns and rows around. I don't know what has to be done exactly, but they
## have 100 school districts in each column and I would definitely get more
## utility out of having them in rows instead so I could join on the rows.

SC_expenditures <- read_excel("States/South Carolina/Expenditure FY 2017-2018.xlsx", skip = 2)%>%
  clean_names() 

SC_expenditures <- SC_expenditures[-c(1,2,7:140), -1] %>% 
  rename(program = x2) %>% 
  pivot_longer(cols = (2:102), names_to = "district_name", values_to = "amount")

SC_teacher_demos <- read_excel("States/South Carolina/SOUTH CAROLINA TEACHERS BY RACE AND GENDER 2015-16.xlsx")  %>% 
  clean_names()
```

```{r South Dakota}
SD_all <- read_excel("States/South Dakota/19-Profile3.xlsx", skip = 4) %>% 
  clean_names()

SD_all <- SD_all[ , -c(3:5, 11:53, 171:220)]

SD_all <- SD_all[ , -c(8:38, 40:67, 70)]

SD_all_financials <- SD_all[ , -c(23,24,25:64)]

SD_ACT <- read_sheet("https://docs.google.com/spreadsheets/d/1kKR-7VN5iBf9WT4COqnSOvCkD_ta2xbgNnuT1JX9lUk/edit#gid=0") %>% clean_names()

SD_joined <- SD_all_financials %>% 
  full_join(SD_ACT, by = "district_name") 

```

```{r Tennessee}
TN_ACT <- read_excel("States/Tennessee/ACT_district_suppressed_2019.xlsx") %>% 
  clean_names()
TN_demos <- read_excel("States/Tennessee/district_profile_2017-18.xlsx") %>% 
  clean_names()
```

```{r Texas}
TX_ACT <- read_csv("States/Texas/act_district_data_class_2017.csv") %>% 
  clean_names()
TX_ACT <- na.omit(TX_ACT)

TX_SAT <- read_csv("States/Texas/sat_district_data_class_2017.csv") %>% 
  clean_names() 
TX_SAT <- na.omit(TX_SAT) 

```

```{r Wisconsin}
WI_ACT <- read_sheet("https://docs.google.com/spreadsheets/d/1Up_UBXF7uX0kc93cFnLVZ-8FS6h7pEnBrl-FbVaMtRk/edit#gid=0") %>% clean_names() %>% 
  rename(district_name = district) 

WI_financial <- read_csv("States/Wisconsin/2017-2018-12-Budget-Data-AtoZ-with-Rollups.csv") %>% 
  clean_names() 

WI_joined <- WI_ACT %>% 
  full_join(WI_financial, by = "district_name")
```

```{r Wyoming}
WY_staff_salaries <- read_csv("States/Wyoming/DistrictVersionAllStaffByCategoryWithAverageSalaries.csv") %>% clean_names()

WY_ACT <- read_sheet("https://docs.google.com/spreadsheets/d/1CivlmlwmrBka8c5oqqQQ4lMqJb981Kvon6luWhZclII/edit#gid=0", skip = 1) %>% clean_names() %>% 
  rename(english = average_5,
         math = average_8,
         reading = average_11, 
         science = average_14,
         composite = average_17)
```


URL for my Shiny app: https://garrett-rolph.shinyapps.io/final-proj-shiny/
